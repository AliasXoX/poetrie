<nav class="nav">
  <div class="nav-content">
    <%= link_to "Poetrie", root_path, class: "nav-brand" %>
    <ul class="nav-links">
      <li><%= link_to "Poems", poems_path, class: "nav-link active" %></li>
      <li><%= link_to "Gallery", images_path, class: "nav-link" %></li>
      <li>
        <%= button_to "Logout", logout_path, method: :delete, class: "nav-link logout-btn", form: { style: "display: inline;" } %>
      </li>
    </ul>
  </div>
</nav>

<div class="container" data-controller="poems">
  <div class="content-wrapper">
    <div class="poem-container">
      <div class="poem-header">
        <h1 class="poem-title"><%= @poem.title %></h1>
      </div>

      <pre class="poem-content" data-poems-target="poemContent" id="poem-<%= @poem.id %>"><% for i in 0..@poem.content.length -%><% if @comments_starting_positions.include?(i) -%><span class="comment-highlight" data-action="click->poems#showComment" id="comment_index-<%= @poem.comments.find_by(start_position: i).id %>"><% end -%><%= @poem.content[i] %><% if @comments_ending_positions.include?(i) -%></span><% end -%><% end -%></pre>

      <%= form_with(model: [@poem, @poem.comments.new], class: 'comment-form hidden', data: { action: "poems#handleSubmit", poems_target: "form" }) do |f| %>
        <%= f.hidden_field :start_position, data: { poems_target: "startPosition"} %>
        <%= f.hidden_field :end_position, data: { poems_target: "endPosition"} %>
        <div class="comment-form-field" id="comment-field-new">
          <%= f.text_field :content, required: true, placeholder: "Add your comment...", class: "comment-input" %>
        </div>
        <div class="comment-form-actions">
          <span class="comment-form-footer" data-action="click->poems#handleCancel">Cancel</span>
          <%= f.submit "Comment", class: "comment-submit-btn" %>
        </div>
      <% end %>

      <%= form_with(url: "", method: :patch, class: 'comment-form hidden', data: { poems_target: "updateForm" }) do %>
        <div class="comment-form-field">
          <%= text_field_tag "comment[content]", @comment.content, required: true, class: "comment-input" %>
        </div>
        <div class="comment-form-actions">
          <span class="comment-form-footer" data-action="click->poems#handleCancel">Cancel</span>
          <%= submit_tag "Update", class: "comment-submit-btn" %>
        </div>
      <% end %>

      <% @poem.comments.each do |comment| %>
        <div class="comment-display hidden" id="comment-<%= comment.id %>" data-poems-target="commentDisplay">
          <div class="comment-header">
            <span class="comment-label">Comment</span>
            <button class="comment-close" data-action="click->poems#hideComment" id="comment_close-<%= comment.id %>" aria-label="Close comment">×</button>
          </div>
          <div class="comment-body">
            <p class="comment-text"><%= comment.content %></p>
          </div>
          <div class="comment-actions">
            <button class="comment-edit-btn" data-action="click->poems#handleEdit" data-poems-target="editButton" id="comment_edit-<%= comment.id %>" title="Edit comment">
              <span class="comment-action-text">Edit</span>
            </button>
            <%= button_to [@poem, comment], method: :delete, data: { confirm: "Are you sure you want to delete this comment?", action: "poems#handlDelete" }, class: "comment-delete-btn", title: "Delete comment" do %>
              <span class="comment-action-text">Delete</span>
            <% end %>
          </div>
        </div>
      <% end %>

      <button class="add-comment-button hidden" data-poems-target="addCommentButton" data-action="click->poems#handleClick" title="Add comment to selected text">
        <span class="add-comment-icon">💬</span>
      </button>

      <div class="poem-footer">
        <%= link_to "← Back", :back, class: "poem-back-link" %>
      </div>
    </div>
  </div>
</div>
